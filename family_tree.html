<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Tree</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden;
        }
        #tree {
            width: 100vw;
            height: 100vh;
        }
        .node rect {
            stroke: #999;
            stroke-width: 2px;
        }
        .node text {
            font: 14px sans-serif;
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #555;
            stroke-width: 2px;
        }
        .partner-link {
            stroke-dasharray: 5,5;
            stroke: #00bcd4;
        }
        .affair-link {
            stroke-dasharray: 5,5;
            stroke: red;
        }
        .button-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }
        button {
            margin-right: 5px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
<div class="button-container">
    <button onclick="addNode()">Add Node</button>
</div>
<svg id="tree"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    const width = window.innerWidth;
    const height = window.innerHeight;

    const svg = d3.select("#tree")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
        }))
        .append("g");

    let idCounter = 0;
    let nodes = [];
    let links = [];

    const g = svg.append("g");

    function update() {
        g.selectAll("*").remove();

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = g.selectAll(".link")
            .data(links)
            .enter().append("line")
            .attr("class", d => {
                if (d.type === "partner") return "link partner-link";
                if (d.type === "affair") return "link affair-link";
                return "link";
            });

        const node = g.selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", (event, d) => editNode(d));

        node.append("rect")
            .attr("width", 100)
            .attr("height", 40)
            .attr("x", -50)
            .attr("y", -20)
            .attr("rx", 10)
            .attr("ry", 10)
            .attr("fill", d => getNodeColor(d));

        node.append("text")
            .attr("dy", 5)
            .attr("text-anchor", "middle")
            .text(d => d.name);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
    }

    function dragstarted(event, d) {
        if (!event.active) event.subject.fx = event.subject.x;
        if (!event.active) event.subject.fy = event.subject.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) {
            d.fx = null;
            d.fy = null;
        }
    }

    function addNode() {
        const name = prompt("Enter name:");
        if (name) {
            nodes.push({ id: ++idCounter + "", name: name, gender: null });
            update();
        }
    }

    function editNode(d) {
        const name = prompt("Edit name:", d.name);
        if (name !== null) {
            d.name = name;
        }

        const gender = prompt("Gender (male/female/leave blank):", d.gender || "");
        if (gender !== null) {
            if (gender.toLowerCase() === "male" || gender.toLowerCase() === "female" || gender.trim() === "") {
                d.gender = gender.toLowerCase();
            } else {
                alert("Invalid gender! Use 'male', 'female', or leave blank.");
            }
        }

        const action = prompt("Add relationship? (parent/partner/affair/none):");
        if (action === "parent" || action === "partner" || action === "affair") {
            const targetName = prompt("Enter the name of the other node:");
            const target = nodes.find(n => n.name === targetName);
            if (target) {
                if (action === "parent") {
                    links.push({ source: target.id, target: d.id });
                } else {
                    links.push({ source: d.id, target: target.id, type: action });
                }
            } else {
                alert("Node not found.");
            }
        }
        update();
    }

    function getNodeColor(d) {
        if (d.gender === "male") return "#6495ED"; // blue
        if (d.gender === "female") return "#FF69B4"; // pink
        return "#ccc"; // grey if no gender
    }

    update();
</script>
</body>
</html>
