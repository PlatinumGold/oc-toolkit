<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OC Timeline Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link
    href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css"
    rel="stylesheet"
  />
<script>
  // â”€â”€ Persistence â”€â”€
  const STORAGE_KEY = 'oc_tl_events';
  let raw = localStorage.getItem(STORAGE_KEY);
  let events = raw
    ? JSON.parse(raw).map(e => ({
        ...e,
        start: new Date(e.start),
        end:    e.end ? new Date(e.end) : undefined
      }))
    : [];

  function saveAll() {
    // when saving, Dates get stringified automatically
    localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
  }

  // â”€â”€ Define two lanes (groups) â”€â”€
  const groups = new vis.DataSet([
    { id:1, content:'Above' },
    { id:2, content:'Below' }
  ]);

  // â”€â”€ Initialize items & timeline â”€â”€
  const items = new vis.DataSet(events);
  const timeline = new vis.Timeline(
    document.getElementById('timeline'),
    { items, groups },
    {
      height:'100%', width:'100%',
      editable:{ updateGroup:true, updateTime:true },
      interaction:{ dragView:true, zoomKey:'ctrlKey' },
      orientation:'bottom', stack:true,
      margin:{ item:10, axis:5 },
      moment: d=> vis.moment(d).utc()
    }
  );

  // auto-fit on load
  timeline.fit();

  // â”€â”€ Sidebar refs â”€â”€
  const sb       = document.getElementById('sidebar');
  const fTitle   = document.getElementById('formTitle');
  const inId     = document.getElementById('evId');
  const inC      = document.getElementById('evContent');
  const inD      = document.getElementById('evDesc');
  const inS      = document.getElementById('evStart');
  const inE      = document.getElementById('evEnd');
  const inCol    = document.getElementById('evColor');
  const inP      = document.getElementById('evPos');
  const btnSave  = document.getElementById('btnSave');
  const btnDel   = document.getElementById('btnDelete');
  const btnCan   = document.getElementById('btnCancel');
  const btnNew   = document.getElementById('btnNew');
  const btnCenter= document.getElementById('btnCenter');

  function isoDate(d) {
    return vis.moment(d).utc().format('YYYY-MM-DD');
  }

  function showForm(data) {
    sb.style.display = 'block';
    if(data) {
      fTitle.textContent = 'Edit Event';
      inId.value = data.id;
      inC.value  = data.content;
      inD.value  = data.description || '';
      inS.value  = isoDate(data.start);
      inE.value  = data.end ? isoDate(data.end) : '';
      const m = /background-color:\s*([^;]+)/.exec(data.style||'');
      inCol.value = m ? m[1] : '#4a90e2';
      inP.value  = data.group;
      btnDel.style.display = 'inline-block';
    } else {
      fTitle.textContent = 'New Event';
      [inId,inC,inD,inS,inE].forEach(i=>i.value='');
      inCol.value = '#4a90e2';
      inP.value   = '1';
      btnDel.style.display = 'none';
    }
  }

  function hideForm() {
    sb.style.display = 'none';
    timeline.unselect();
  }

  // â”€â”€ Wire up buttons â”€â”€
  btnNew.onclick    = ()=> showForm(null);
  btnCenter.onclick = ()=> timeline.moveTo(new Date());

  timeline.on('doubleClick', props => {
    if(props.what==='background') {
      showForm({ start: props.time, group:1, style:'background-color:#4a90e2;' });
    }
  });

  timeline.on('select', props => {
    if(props.items.length===1) {
      const ev = items.get(props.items[0]);
      showForm(ev);
    }
  });

  // â”€â”€ Save or add â”€â”€
  btnSave.onclick = ()=>{
    const id = inId.value || Date.now();
    const content = inC.value.trim();
    if(!content) return alert('Title required');
    const start = inS.value ? new Date(inS.value) : new Date();
    const end   = inE.value ? new Date(inE.value) : undefined;
    const color = inCol.value;
    const group = Number(inP.value);
    const style = `background-color:${color}; border-color:${color};`;

    const rec = { id, content, start, group, style, description: inD.value };
    if(end) rec.end = end;

    if(inId.value) {
      items.update(rec);
      events = events.map(e=> e.id==id ? rec : e);
    } else {
      items.add(rec);
      events.push(rec);
    }
    saveAll();
    hideForm();
  };

  // â”€â”€ Delete â”€â”€
  btnDel.onclick = ()=>{
    const id = inId.value;
    items.remove(id);
    events = events.filter(e=> e.id!=id);
    saveAll();
    hideForm();
  };

  // â”€â”€ Cancel â”€â”€
  btnCan.onclick = hideForm;
</script>

</head>
<body>

  <div id="header">
    ðŸ“… OC Timeline Manager
    <button id="btnCenter">Center</button>
    <button id="btnNew">New Event</button>
  </div>

  <div id="main">
    <div id="timeline"></div>

    <div id="sidebar">
      <h2 id="formTitle">New Event</h2>
      <input type="hidden" id="evId" />

      <label>Title</label>
      <input id="evContent" placeholder="Event titleâ€¦" />

      <label>Description</label>
      <textarea id="evDesc" placeholder="Optional descriptionâ€¦"></textarea>

      <label>Start Date</label>
      <input id="evStart" type="date" />

      <label>End Date (optional)</label>
      <input id="evEnd" type="date" />

      <label>Color</label>
      <input id="evColor" type="color" value="#4a90e2" />

      <label>Position</label>
      <select id="evPos">
        <option value="1">Above line</option>
        <option value="2">Below line</option>
      </select>

      <div class="actions">
        <button class="save"   id="btnSave">Save</button>
        <button class="delete" id="btnDelete">Delete</button>
        <button class="cancel" id="btnCancel">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <script>
    // â”€â”€ Persistence â”€â”€
    const STORAGE_KEY = 'oc_tl_events';
    let events = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    function saveAll() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
    }

    // â”€â”€ Define two lanes (groups) â”€â”€
    const groups = new vis.DataSet([
      { id:1, content:'Above' },
      { id:2, content:'Below' }
    ]);

    // â”€â”€ Initialize items & timeline â”€â”€
    const items = new vis.DataSet(events);
    const timeline = new vis.Timeline(
      document.getElementById('timeline'),
      { items, groups },
      {
        height:'100%', width:'100%',
        editable:{ updateGroup:true, updateTime:true },
        interaction:{ dragView:true, zoomKey:'ctrlKey' },
        orientation:'bottom', stack:true,
        margin:{ item:10, axis:5 },
        moment: d=> vis.moment(d).utc()
      }
    );

    // auto-fit on load
    timeline.fit();

    // â”€â”€ Sidebar references â”€â”€
    const sb       = document.getElementById('sidebar');
    const fTitle   = document.getElementById('formTitle');
    const inId     = document.getElementById('evId');
    const inC      = document.getElementById('evContent');
    const inD      = document.getElementById('evDesc');
    const inS      = document.getElementById('evStart');
    const inE      = document.getElementById('evEnd');
    const inCol    = document.getElementById('evColor');
    const inP      = document.getElementById('evPos');
    const btnSave  = document.getElementById('btnSave');
    const btnDel   = document.getElementById('btnDelete');
    const btnCan   = document.getElementById('btnCancel');
    const btnNew   = document.getElementById('btnNew');
    const btnCenter= document.getElementById('btnCenter');

    function isoDate(d) {
      return vis.moment(d).utc().format('YYYY-MM-DD');
    }

    function showForm(data) {
      sb.style.display = 'block';
      if(data) {
        fTitle.textContent = 'Edit Event';
        inId.value = data.id;
        inC.value  = data.content;
        inD.value  = data.description || '';
        inS.value  = isoDate(data.start);
        inE.value  = data.end ? isoDate(data.end) : '';
        // extract color from style
        const m = /background-color:\s*([^;]+)/.exec(data.style||'');
        inCol.value = m ? m[1] : '#4a90e2';
        inP.value  = data.group;
        btnDel.style.display = 'inline-block';
      } else {
        fTitle.textContent = 'New Event';
        [inId,inC,inD,inS,inE].forEach(i=>i.value='');
        inCol.value = '#4a90e2';
        inP.value   = '1';
        btnDel.style.display = 'none';
      }
    }

    function hideForm() {
      sb.style.display = 'none';
      timeline.unselect();
    }

    // â”€â”€ New / Center buttons â”€â”€
    btnNew.onclick    = ()=> showForm(null);
    btnCenter.onclick = ()=> timeline.moveTo(new Date());

    // â”€â”€ Double-click background to add â”€â”€
    timeline.on('doubleClick', props => {
      if(props.what==='background') {
        showForm({ start: props.time, group:1, style:'background-color:#4a90e2;' });
      }
    });

    // â”€â”€ Select existing â”€â”€
    timeline.on('select', props => {
      if(props.items.length===1) {
        const ev = items.get(props.items[0]);
        showForm(ev);
      }
    });

    // â”€â”€ Save event â”€â”€
    btnSave.onclick = ()=>{
      const id = inId.value || Date.now();
      const content = inC.value.trim();
      if(!content) return alert('Title required');
      const start = inS.value ? new Date(inS.value) : new Date();
      const end   = inE.value ? new Date(inE.value) : undefined;
      const color = inCol.value;
      const group = Number(inP.value);
      const style = `background-color:${color}; border-color:${color};`;

      const rec = { id, content, start, group, style, description: inD.value };
      if(end) rec.end = end;

      if(inId.value) {
        items.update(rec);
        events = events.map(e=> e.id == id ? rec : e);
      } else {
        items.add(rec);
        events.push(rec);
      }
      saveAll();
      hideForm();
    };

    // â”€â”€ Delete event â”€â”€
    btnDel.onclick = ()=>{
      const id = inId.value;
      items.remove(id);
      events = events.filter(e=> e.id != id);
      saveAll();
      hideForm();
    };

    // â”€â”€ Cancel â”€â”€
    btnCan.onclick = hideForm;
  </script>
</body>
</html>
