<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>OC Family Tree (vis.js + Link Mode)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet"/>
  <style>
    body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
    #network { flex:1; position:relative; background:#eef2f5; overflow:auto; }
    #header { background:#446688; color:#fff; padding:10px; text-align:center; }
    #controls { padding:8px; background:#fff; border-bottom:1px solid #ccc; text-align:center; }
    #controls button { margin:0 5px; }
    #sidebar {
      width:320px; background:#fff; border-left:1px solid #ccc;
      padding:15px; box-sizing:border-box; overflow-y:auto;
    }
    #sidebar.hidden { display:none; }
    #sidebar h2 { margin-top:0; color:#334e68; }
    label { display:block; margin:10px 0 4px; font-weight:bold; }
    input, select, textarea, button {
      width:100%; padding:6px; margin-bottom:8px; box-sizing:border-box;
    }
    textarea { resize: vertical; }
    .rel-buttons button { margin:4px 2px; }
  </style>
</head>
<body>

  <div id="network">
    <div id="header">ðŸ§¬ OC Family Tree</div>
    <div id="controls">
      <button id="addRelTypeBtn">+ Add Rel Type</button>
      <button id="linkModeBtn">ðŸ”— Link Mode: Off</button>
    </div>
  </div>

  <div id="sidebar" class="hidden">
    <h2>Edit Character</h2>
    <label>Name</label><input id="nName"/>
    <label>Age</label><input id="nAge"/>
    <label>Gender</label>
    <select id="nGender">
      <option value="">Unknown</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
    <label>DOB</label><input id="nDOB" type="date"/>
    <label>DOD</label><input id="nDOD" type="date"/>
    <label>Notes</label><textarea id="nNotes" rows="3"></textarea>

    <label>Existing Character â†’</label>
    <select id="linkTarget"><option value="">Select...</option></select>
    <label>Relationship Type</label>
    <select id="linkType"></select>
    <button id="linkBtn">Link Selected</button>

    <div class="rel-buttons" id="relButtons"></div>
    <button id="saveBtn">Save</button>
    <button id="deleteBtn" style="background:#c53;color:#fff;">Delete</button>
  </div>

  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script>
    // --- Data & Rel Types ---
    let idCount=0;
    const newId=()=> 'n'+(++idCount);
    const relTypes=[
      {key:'parent',label:'Parent',style:{dashes:false,color:'#000'}},
      {key:'child',label:'Child',style:{dashes:false,color:'#000'}},
      {key:'sibling',label:'Sibling',style:{dashes:false,color:'#000'}},
      {key:'partner',label:'Partner',style:{dashes:true,color:'#333'}},
      {key:'affair',label:'Affair',style:{dashes:true,color:'#c00'}}
    ];

    // vis Data
    const nodes=new vis.DataSet(), edges=new vis.DataSet();
    nodes.add({
      id:newId(), label:'Main OC', name:'Main OC', age:'', gender:'', dob:'', dod:'', notes:''
    });

    // Network
    const network=new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        layout:{hierarchical:false},
        interaction:{dragNodes:true,dragView:true,zoomView:true},
        physics:{enabled:false},
        nodes:{shape:'box',margin:10,font:{align:'left'}},
        edges:{arrows:{to:{enabled:true,type:'arrow'}},smooth:{type:'straightCross'}}
      }
    );

    // Sidebar refs
    const sidebar=document.getElementById('sidebar');
    const fld={ name:1,age:1,gender:1,dob:1,dod:1,notes:1 };
    fld.name=document.getElementById('nName');
    fld.age=document.getElementById('nAge');
    fld.gender=document.getElementById('nGender');
    fld.dob=document.getElementById('nDOB');
    fld.dod=document.getElementById('nDOD');
    fld.notes=document.getElementById('nNotes');
    const relButtons=document.getElementById('relButtons');
    const saveBtn=document.getElementById('saveBtn');
    const deleteBtn=document.getElementById('deleteBtn');
    const addRelTypeBtn=document.getElementById('addRelTypeBtn');
    const linkModeBtn=document.getElementById('linkModeBtn');
    const linkTarget=document.getElementById('linkTarget');
    const linkType=document.getElementById('linkType');
    const linkBtn=document.getElementById('linkBtn');
    let selectedId=null, linkMode=false;

    // Populate linkType select
    function refreshLinkType(){
      linkType.innerHTML='';
      relTypes.forEach(rt=>{
        const o=document.createElement('option');
        o.value=rt.key; o.textContent=rt.label;
        linkType.appendChild(o);
      });
    }

    // Toggle link mode
    linkModeBtn.onclick=()=>{
      linkMode = !linkMode;
      linkModeBtn.textContent = 'ðŸ”— Link Mode: ' + (linkMode?'On':'Off');
    };

    // Add custom rel type
    addRelTypeBtn.onclick=()=>{
      const label=prompt('New relationship label?');
      if(!label)return;
      const key=label.toLowerCase().replace(/\\s+/g,'');
      relTypes.push({key,label,style:{dashes:false,color:'#555'}});
      refreshLinkType();
      buildRelButtons();
    };

    // Handle network clicks for link mode
    network.on('click', params=>{
      if(linkMode && params.nodes.length){
        const id=params.nodes[0];
        if(!selectedId) {
          selectedId = id;
          alert('Source selected. Now click another node or use the dropdown.');
        } else {
          applyLink(id, linkTypesEl.value);
          selectedId=null;
        }
      }
    });

    // Node select
    network.on('selectNode', params=>{
      selectedId=params.nodes[0];
      const d=nodes.get(selectedId);
      // fill fields
      fld.name.value=d.name;
      fld.age.value=d.age;
      fld.gender.value=d.gender;
      fld.dob.value=d.dob;
      fld.dod.value=d.dod;
      fld.notes.value=d.notes;
      // populate linkTarget
      linkTarget.innerHTML='<option value="">Select...</option>';
      nodes.forEach(n=>{
        if(n.id!==selectedId){
          const o=document.createElement('option');
          o.value=n.id; o.textContent=n.name;
          linkTarget.appendChild(o);
        }
      });
      refreshLinkType();
      buildRelButtons();
      sidebar.classList.remove('hidden');
    });
    network.on('deselectNode',()=>{ selectedId=null; sidebar.classList.add('hidden'); });

    // Save edits
    saveBtn.onclick=()=>{
      if(!selectedId)return;
      const upd={id:selectedId};
      upd.name=fld.name.value;
      upd.age=fld.age.value;
      upd.gender=fld.gender.value;
      upd.dob=fld.dob.value;
      upd.dod=fld.dod.value;
      upd.notes=fld.notes.value;
      let label=upd.name;
      if(upd.age)    label+='\nAge: '+upd.age;
      if(upd.dob)    label+='\nBorn: '+upd.dob;
      if(upd.dod)    label+='\nDied: '+upd.dod;
      upd.label=label;
      if(upd.gender==='male')    upd.color={border:'#4b8bbe',background:'#eef4fc'};
      if(upd.gender==='female')  upd.color={border:'#d2527f',background:'#fdeef4'};
      nodes.update(upd);
    };
    // Delete
    deleteBtn.onclick=()=>{
      if(!selectedId)return;
      nodes.remove(selectedId);
      edges.get().forEach(e=>{ if(e.from===selectedId||e.to===selectedId)edges.remove(e.id); });
      sidebar.classList.add('hidden');
    };

    // Build sidebar rel-buttons
    function buildRelButtons(){
      relButtons.innerHTML='';
      relTypes.forEach(rt=>{
        const b=document.createElement('button');
        b.textContent=rt.label;
        b.onclick=e=>{
          e.stopPropagation();
          if(!selectedId)return;
          const nid=newId();
          nodes.add({id:nid,label:rt.label,name:rt.label,age:'',gender:'',dob:'',dod:'',notes:''});
          if(rt.key==='parent')   linkNodes(nid,selectedId,rt.style);
          else if(rt.key==='child')linkNodes(selectedId,nid,rt.style);
          else if(rt.key==='sibling'){
            edges.get({filter:e=>e.to===selectedId&&!e.dashes})
                 .forEach(e2=>linkNodes(e2.from,nid,rt.style));
          } else if(rt.key==='partner'||rt.key==='affair'){
            linkNodes(selectedId,nid,rt.style);
            linkNodes(nid,selectedId,rt.style);
          } else {
            // custom: one-way
            linkNodes(selectedId,nid,rt.style);
          }
        };
        relButtons.appendChild(b);
      });
    }

    // Link via relButtons or link form
    function linkNodes(f,t,style){
      edges.add({from:f,to:t,dashes:style.dashes,color:{color:style.color},arrows:{to:{enabled:true,type:'arrow'}}});
    }
    function applyLink(targetId, relKey){
      if(!selectedId||!targetId||!relKey)return;
      const rt=relTypes.find(r=>r.key===relKey);
      if(rt.key==='parent')   linkNodes(targetId,selectedId,rt.style);
      if(rt.key==='child')    linkNodes(selectedId,targetId,rt.style);
      if(rt.key==='sibling'){
        edges.get({filter:e=>e.to===selectedId&&!e.dashes})
             .forEach(e2=>linkNodes(e2.from,targetId,rt.style));
      }
      if(rt.key==='partner'||rt.key==='affair'){
        linkNodes(selectedId,targetId,rt.style);
        linkNodes(targetId,selectedId,rt.style);
      }
    }
    linkBtn.onclick=()=>{
      applyLink(linkTarget.value, linkType.value);
    };

    // Kickoff
    render();
  </script>
</body>
</html>
