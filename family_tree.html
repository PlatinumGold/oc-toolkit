<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OC Family Tree (vis.js Hybrid)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet"/>
  <style>
    body { margin:0; display:flex; height:100vh; font-family:Arial,sans-serif; }
    #leftPane { flex:1; position:relative; }
    #network { width:100%; height:100%; background:#eef2f5; }
    header {
      background:#8e44ad; color:#fff;
      padding:12px; text-align:center; font-size:1.3em;
    }
    #controls {
      background:#fff; border-bottom:1px solid #ccc;
      padding:6px; text-align:center;
    }
    #controls button {
      margin:0 4px; padding:6px 10px; cursor:pointer;
    }
    #sidebar {
      width:300px; background:#fff; border-left:1px solid #ccc;
      display:flex; flex-direction:column; overflow-y:auto;
    }
    #sidebar.hidden { display:none; }
    #sidebar h2 { margin:12px 0 6px 0; color:#4a90e2; text-align:center; }
    #sidebar label { margin:8px 0 4px 0; font-weight:bold; }
    #sidebar input, #sidebar select, #sidebar textarea, #sidebar button {
      width:100%; margin-bottom:8px; padding:6px; box-sizing:border-box;
    }
    #sidebar textarea { resize: vertical; }
    #sidebar .rel-buttons button, #sidebar .link-controls button {
      margin:4px 2px; padding:6px; cursor:pointer;
    }
    #sidebar .link-controls select { margin:4px 2px; padding:6px; }
  </style>
</head>
<body>

  <div id="leftPane">
    <header>üß¨ OC Family Tree</header>
    <div id="controls">
      <button id="addNodeBtn">‚ûï Add Node</button>
      <button id="addRelTypeBtn">‚ûï Add Rel Type</button>
    </div>
    <div id="network"></div>
  </div>

  <div id="sidebar" class="hidden">
    <h2>Edit Character</h2>

    <label>Name</label>
    <input id="nName"/>

    <label>Age</label>
    <input id="nAge"/>

    <label>Gender</label>
    <select id="nGender">
      <option value="">Unknown</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>

    <label>DOB</label>
    <input id="nDOB" type="date"/>

    <label>DOD</label>
    <input id="nDOD" type="date"/>

    <label>Image</label>
    <input id="nImg" type="file" accept="image/*"/>

    <label>Box Color</label>
    <input id="nColor" type="color" value="#cccccc"/>

    <label>Notes</label>
    <textarea id="nNotes" rows="3"></textarea>

    <div class="rel-buttons" id="relButtons"></div>

    <div class="link-controls">
      <label>Link Existing</label>
      <select id="linkType"></select>
      <select id="linkTarget"></select>
      <button id="linkBtn">Link</button>
    </div>

    <button id="saveBtn">üíæ Save</button>
    <button id="deleteBtn" style="background:#c53;color:#fff;">üóëÔ∏è Delete</button>
  </div>


<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
  // ‚Äî Utilities ‚Äî
  let idCount = 0;
  function newId() { return ++idCount; }

  // ‚Äî Relationship definitions ‚Äî
  const relTypes = [
    { key:'parent',  label:'Parent',  style:{ dashes:false, color:'#000' } },
    { key:'child',   label:'Child',   style:{ dashes:false, color:'#000' } },
    { key:'sibling', label:'Sibling', style:{ dashes:false, color:'#0066cc'} },
    { key:'partner', label:'Partner', style:{ dashes:true,  color:'#666' } },
    { key:'affair',  label:'Affair',  style:{ dashes:true,  color:'#c00' } }
  ];

  // ‚Äî DataSets ‚Äî
  const nodes = new vis.DataSet();
  const edges = new vis.DataSet();

  // add initial node
  nodes.add({
    id: newId(),
    label: 'Main OC',
    name:'Main OC', age:'', gender:'', dob:'', dod:'', notes:'',
    color:{ border:'#4a90e2', background:'#ccc' },
    shape:'box'
  });

  // ‚Äî Network Setup ‚Äî
  const container = document.getElementById('network');
  const network = new vis.Network(container,
    { nodes, edges },
    {
      layout:{ hierarchical:false },
      interaction:{ dragNodes:true, dragView:true, zoomView:true },
      physics:false,
      manipulation:{
        enabled:true,
        addNode: (data, cb) => {
          const name = prompt('New OC name:','');
          if(!name) return;
          Object.assign(data, {
            label:name, name, age:'', gender:'', dob:'', dod:'', notes:'',
            color:{ border:'#4a90e2', background:'#ccc' }, shape:'box'
          });
          cb(data);
        },
        deleteNode:true,
        deleteEdge:true
      },
      nodes:{
        shape:'box',
        margin:10,
        widthConstraint:{ minimum:120 },
        heightConstraint:{ minimum:120 },
        color:{ border:'#4a90e2', background:'#fff' },
        font:{ align:'left' },
        shapeProperties:{ useImageSize:false }
      },
      edges:{ arrows:{ to:{enabled:true,type:'arrow'}}, smooth:false }
    }
  );

  // ‚Äî Sidebar Logic ‚Äî
  const sidebar    = document.getElementById('sidebar');
  const fld        = {
    name:   document.getElementById('nName'),
    age:    document.getElementById('nAge'),
    gender: document.getElementById('nGender'),
    dob:    document.getElementById('nDOB'),
    dod:    document.getElementById('nDOD'),
    img:    document.getElementById('nImg'),
    color:  document.getElementById('nColor'),
    notes:  document.getElementById('nNotes')
  };
  const relButtons    = document.getElementById('relButtons');
  const saveBtn       = document.getElementById('saveBtn');
  const deleteBtn     = document.getElementById('deleteBtn');
  const addRelTypeBtn = document.getElementById('addRelTypeBtn');
  const linkTypeSel   = document.getElementById('linkType');
  const linkTargetSel = document.getElementById('linkTarget');
  const linkBtn       = document.getElementById('linkBtn');
  const addNodeBtn    = document.getElementById('addNodeBtn');
  let selectedId = null;

  function buildRelButtons() {
    relButtons.innerHTML = '';
    relTypes.forEach(rt=>{
      const b=document.createElement('button');
      b.textContent=rt.label;
      b.onclick=e=>{
        e.stopPropagation();
        const nid=newId();
        nodes.add({
          id:nid, label:rt.label, name:rt.label,
          age:'', gender:'', dob:'', dod:'', notes:'',
          color:{ border:'#4a90e2', background:'#ccc' },
          shape:'box'
        });
        if(rt.key==='parent')   edges.add({ from:nid,to:selectedId,   dashes:rt.style.dashes,color:{color:rt.style.color} });
        if(rt.key==='child')    edges.add({ from:selectedId,to:nid,   dashes:rt.style.dashes,color:{color:rt.style.color} });
        if(rt.key==='sibling'){
          edges.get({ filter:e2=>e2.to===selectedId&&!e2.dashes }).forEach(e2=>{
            edges.add({ from:e2.from,to:nid,dashes:false,color:{color:'#0066cc'} });
          });
        }
        if(rt.key==='partner'){
          edges.add({ from:selectedId,to:nid,dashes:rt.style.dashes,color:{color:rt.style.color} });
          edges.add({ from:nid,to:selectedId,dashes:rt.style.dashes,color:{color:rt.style.color} });
        }
        if(rt.key==='affair'){
          edges.add({ from:selectedId,to:nid,dashes:rt.style.dashes,color:{color:rt.style.color} });
          edges.add({ from:nid,to:selectedId,dashes:rt.style.dashes,color:{color:rt.style.color} });
        }
        refreshLinkControls();
      };
      relButtons.appendChild(b);
    });
  }

  function refreshLinkControls(){
    linkTypeSel.innerHTML='';
    relTypes.forEach(rt=>{
      const o=document.createElement('option');
      o.value=rt.key; o.textContent=rt.label;
      linkTypeSel.appendChild(o);
    });
    linkTargetSel.innerHTML='<option value="">Select...</option>';
    nodes.forEach(n=>{
      if(n.id!==selectedId){
        const o=document.createElement('option');
        o.value=n.id; o.textContent=n.label.split('\n')[0];
        linkTargetSel.appendChild(o);
      }
    });
  }

  network.on('selectNode',params=>{
    selectedId=params.nodes[0];
    const data=nodes.get(selectedId);
    fld.name.value   = data.name;
    fld.age.value    = data.age;
    fld.gender.value = data.gender;
    fld.dob.value    = data.dob;
    fld.dod.value    = data.dod;
    fld.notes.value  = data.notes;
    fld.img.value    = ''; 
    fld.color.value  = data.color?.background || '#cccccc';
    buildRelButtons();
    refreshLinkControls();
    sidebar.classList.remove('hidden');
  });

  network.on('deselectNode',()=>{
    sidebar.classList.add('hidden');
    selectedId = null;
  });

  saveBtn.onclick=()=>{
    if(!selectedId) return;
    const upd = { id: selectedId };
    upd.name   = fld.name.value;
    upd.age    = fld.age.value;
    upd.gender = fld.gender.value;
    upd.dob    = fld.dob.value;
    upd.dod    = fld.dod.value;
    upd.notes  = fld.notes.value;

    let lines = [upd.name];
    if(upd.age) lines.push('Age: '+upd.age);
    if(upd.dob) lines.push('b. '+upd.dob);
    if(upd.dod) lines.push('d. '+upd.dod);
    if(upd.notes) lines.push(upd.notes);
    upd.label = lines.join('\n');

    // default fallback: box + chosen color
    upd.color = { border:'#4a90e2', background: fld.color.value };
    upd.shape = 'box';

    // if image selected ‚Üí use image shape
    if(fld.img.files[0]){
      const fr = new FileReader();
      fr.onload = e=>{
        upd.image = e.target.result;
        upd.shape = 'image';
        nodes.update(upd);
      };
      fr.readAsDataURL(fld.img.files[0]);
    } else {
      nodes.update(upd);
    }
  };

  deleteBtn.onclick=()=>{
    if(!selectedId) return;
    nodes.remove(selectedId);
    edges.get().forEach(e=>{ if(e.from===selectedId||e.to===selectedId) edges.remove(e.id); });
    sidebar.classList.add('hidden');
  };

  linkBtn.onclick=()=>{
    if(!selectedId) return alert('Select target!');
    const type = linkTypeSel.value, tgt = +linkTargetSel.value;
    if(!type||!tgt) return;
    const rt = relTypes.find(r=>r.key===type);
    if(type==='parent')   edges.add({ from:tgt,to:selectedId,   dashes:rt.style.dashes,color:{color:rt.style.color} });
    if(type==='child')    edges.add({ from:selectedId,to:tgt,   dashes:rt.style.dashes,color:{color:rt.style.color} });
    if(type==='sibling'){
      edges.get({ filter:e2=>e2.to===selectedId&&!e2.dashes }).forEach(e2=>{
        edges.add({ from:e2.from,to:tgt,dashes:false,color:{color:'#0066cc'} });
      });
    }
    if(type==='partner'||type==='affair'){
      edges.add({ from:selectedId,to:tgt, dashes:rt.style.dashes, color:{color:rt.style.color} });
      edges.add({ from:tgt,to:selectedId, dashes:rt.style.dashes, color:{color:rt.style.color} });
    }
  };

  addRelTypeBtn.onclick=()=>{
    const lbl = prompt('New relationship label?');
    if(!lbl) return;
    const key = lbl.toLowerCase().replace(/\s+/g,'');
    relTypes.push({ key,label:lbl, style:{ dashes:false, color:'#555'} });
    if(selectedId){ buildRelButtons(); refreshLinkControls(); }
  };

  addNodeBtn.onclick=()=>{
    const name = prompt('New OC name:','');
    if(!name) return;
    const nid = newId();
    nodes.add({
      id:nid, label:name, name, age:'', gender:'', dob:'', dod:'', notes:'',
      color:{ border:'#4a90e2', background:'#ccc' }, shape:'box'
    });
    network.selectNodes([nid]);
  };
</script>
</body>
</html>
