<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OC Family Tree</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet"/>
  <style>
    body { margin:0; display:flex; height:100vh; font-family:Arial,sans-serif; }
    #leftPane { flex:1; position:relative; background:#eef2f5; }
    #header {
      background:#4a90e2; color:#fff; padding:12px; text-align:center;
      font-size:1.3em; position:absolute; top:0; left:0; right:0; z-index:1;
    }
    #network {
      width:100%; height:100%; padding-top:48px;
    }
    #sidebar {
      width:300px; background:#fff; border-left:1px solid #ccc;
      overflow-y:auto; padding:15px; box-sizing:border-box;
    }
    #sidebar.hidden { display:none; }
    #sidebar h2 { margin-top:0; color:#4a90e2; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, select, textarea, button {
      width:100%; padding:6px; margin-top:4px; box-sizing:border-box;
    }
    textarea { resize:vertical; }
    .rel-buttons, .link-controls { margin-top:12px; }
    .rel-buttons button, .link-controls button, .link-controls select {
      margin:4px 2px; padding:6px; font-size:0.9em; cursor:pointer;
    }
  </style>
</head>
<body>

  <div id="leftPane">
    <div id="header">ðŸ§¬ OC Family Tree</div>
    <div id="network"></div>
  </div>

  <div id="sidebar" class="hidden">
    <h2>Edit Character</h2>
    <label>Name</label><input id="fldName"/>
    <label>Age</label><input id="fldAge"/>
    <label>Gender</label>
      <select id="fldGender">
        <option value="">Unknown</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    <label>DOB</label><input id="fldDOB" type="date"/>
    <label>DOD</label><input id="fldDOD" type="date"/>
    <label>Notes</label><textarea id="fldNotes" rows="3"></textarea>

    <div class="rel-buttons" id="relButtons"></div>

    <div class="link-controls">
      <label>Link Relation</label>
      <select id="linkType"></select>
      <label>Link To</label>
      <select id="linkTarget"><option value="">Selectâ€¦</option></select>
      <button id="linkBtn">Create Link</button>
    </div>

    <button id="saveBtn" style="margin-top:12px;">Save</button>
    <button id="deleteBtn" style="margin-top:6px;background:#c53;color:#fff;">Delete</button>
  </div>

  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script>
    // ID generator
    let nextId = 0;
    function genId(){ return ++nextId; }

    // Relationship styles
    const relStyles = {
      parent:  { dashes:false, color:'#000'    },
      child:   { dashes:false, color:'#000'    },
      sibling: { dashes:false, color:'#0066cc' },
      partner: { dashes:true,  color:'#666'    },
      affair:  { dashes:true,  color:'#c00'    }
    };

    // Setup vis.js
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    nodes.add({ id: genId(), label:'Main OC' });

    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        interaction:{ dragNodes:true, dragView:true, zoomView:true },
        physics: false,
        nodes:{ shape:'box', margin:10, color:{border:'#4a90e2',background:'#fff'}, font:{align:'left'} },
        edges:{ arrows:{ to:{enabled:true,type:'arrow'}}, smooth:false }
      }
    );

    // Sidebar refs
    const sidebar    = document.getElementById('sidebar');
    const fld        = {
      name:   document.getElementById('fldName'),
      age:    document.getElementById('fldAge'),
      gender: document.getElementById('fldGender'),
      dob:    document.getElementById('fldDOB'),
      dod:    document.getElementById('fldDOD'),
      notes:  document.getElementById('fldNotes')
    };
    const relButtons   = document.getElementById('relButtons');
    const linkTypeSel  = document.getElementById('linkType');
    const linkTargetSel= document.getElementById('linkTarget');
    const linkBtn      = document.getElementById('linkBtn');
    const saveBtn      = document.getElementById('saveBtn');
    const deleteBtn    = document.getElementById('deleteBtn');

    let selectedId = null;

    // Build rel-buttons and link dropdowns
    function buildSidebarUI() {
      // rel-buttons
      relButtons.innerHTML = '';
      for (let key in relStyles) {
        const btn = document.createElement('button');
        btn.textContent = key.charAt(0).toUpperCase() + key.slice(1);
        btn.onclick = () => addRelationship(key);
        relButtons.appendChild(btn);
      }
      // link-type
      linkTypeSel.innerHTML = '';
      Object.keys(relStyles).forEach(key=>{
        const o=document.createElement('option');
        o.value=key; o.textContent=key.charAt(0).toUpperCase()+key.slice(1);
        linkTypeSel.appendChild(o);
      });
      // link-target
      linkTargetSel.innerHTML = '<option value="">Selectâ€¦</option>';
      nodes.forEach(n=>{
        if (n.id !== selectedId) {
          const o=document.createElement('option');
          o.value=n.id; o.textContent=n.label.split('\n')[0];
          linkTargetSel.appendChild(o);
        }
      });
    }

    // On node select
    network.on('selectNode', params=>{
      selectedId = params.nodes[0];
      const d = nodes.get(selectedId);

      // Fill fields
      fld.name.value   = d._name   || d.label.split('\n')[0] || '';
      fld.age.value    = d._age    || '';
      fld.gender.value = d._gender || '';
      fld.dob.value    = d._dob    || '';
      fld.dod.value    = d._dod    || '';
      fld.notes.value  = d._notes  || '';

      buildSidebarUI();
      sidebar.classList.remove('hidden');
    });

    network.on('deselectNode', ()=>{
      selectedId = null;
      sidebar.classList.add('hidden');
    });

    // Save edits
    saveBtn.onclick = ()=>{
      if (!selectedId) return;
      const upd = { id: selectedId };

      const name   = fld.name.value.trim() || 'Unnamed';
      const age    = fld.age.value.trim();
      const gender = fld.gender.value;
      const dob    = fld.dob.value;
      const dod    = fld.dod.value;
      const notes  = fld.notes.value.trim();

      // store raw
      upd._name   = name;
      upd._age    = age;
      upd._gender = gender;
      upd._dob    = dob;
      upd._dod    = dod;
      upd._notes  = notes;

      // build multiline label
      let lines = [name];
      if (age)    lines.push('Age: ' + age);
      if (dob)    lines.push('b. ' + dob);
      if (dod)    lines.push('d. ' + dod);
      if (notes)  lines.push(notes);
      upd.label = lines.join('\n');

      // color by gender
      if (gender==='male')   upd.color={border:'#4b8bbe',background:'#eef4fc'};
      else if (gender==='female') upd.color={border:'#d2527f',background:'#fdeef4'};
      else upd.color={border:'#4a90e2',background:'#fff'};

      nodes.update(upd);
    };

    // Delete node & its edges
    deleteBtn.onclick = ()=>{
      if (!selectedId) return;
      nodes.remove(selectedId);
      edges.get().forEach(e=>{ if(e.from===selectedId||e.to===selectedId) edges.remove(e.id); });
      sidebar.classList.add('hidden');
    };

    // Quick add relationships (create new node + edge)
    function addRelationship(type) {
      if (!selectedId) return;
      const nid = genId();
      const label = type.charAt(0).toUpperCase() + type.slice(1);
      nodes.add({ id: nid, label });
      const style = relStyles[type];
      if (type==='parent')  edges.add({ from:nid, to:selectedId, dashes:style.dashes, color:{color:style.color} });
      else if (type==='child') edges.add({ from:selectedId, to:nid, dashes:style.dashes, color:{color:style.color} });
      else if (type==='sibling') {
        // link new node to all parents of selected
        edges.get({ filter:e => e.to===selectedId && !e.dashes })
             .forEach(e=>edges.add({ from:e.from, to:nid, dashes:false, color:{color:'#0066cc'} }));
      }
      else if (type==='partner' || type==='affair') {
        edges.add({ from:selectedId, to:nid, dashes:style.dashes, color:{color:style.color} });
        edges.add({ from:nid, to:selectedId, dashes:style.dashes, color:{color:style.color} });
      }
    }

    // Link existing nodes (incest, step relations, etc.)
    linkBtn.onclick = ()=>{
      if (!selectedId) return alert('Select a node first');
      const type = linkTypeSel.value;
      const tgt  = parseInt(linkTargetSel.value);
      if (!type||!tgt) return alert('Pick relationship type and target');
      const style = relStyles[type];
      // reuse addRelationship logic but without new node
      if (type==='parent')  edges.add({ from:tgt, to:selectedId, dashes:style.dashes, color:{color:style.color} });
      else if(type==='child') edges.add({ from:selectedId, to:tgt, dashes:style.dashes, color:{color:style.color} });
      else if(type==='sibling') {
        edges.get({ filter:e=>e.to===selectedId && !e.dashes })
             .forEach(e=>edges.add({ from:e.from, to:tgt, dashes:false, color:{color:'#0066cc'} }));
      }
      else if(type==='partner'||type==='affair') {
        edges.add({ from:selectedId, to:tgt, dashes:style.dashes, color:{color:style.color} });
        edges.add({ from:tgt, to:selectedId, dashes:style.dashes, color:{color:style.color} });
      }
    };

  </script>
</body>
</html>
