<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OC Family Tree (vis.js)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; }
    #network { flex: 1; background: #eef2f5; }
    #sidebar {
      width: 300px; background: #fff; border-left: 1px solid #ccc;
      padding: 15px; box-sizing: border-box; overflow-y: auto;
    }
    #sidebar.hidden { display: none; }
    #header { background: #446688; color: #fff; padding: 10px; text-align: center; }
    #controls { padding: 10px; background: #fff; border-bottom: 1px solid #ccc; text-align: center; }
    #controls button { margin: 0 5px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 5px; margin-top: 4px; box-sizing: border-box; }
    textarea { resize: vertical; }
    .rel-buttons button { margin: 4px 2px; padding: 6px; }
  </style>
</head>
<body>

  <div id="network">
    <div id="header">ðŸ§¬ OC Family Tree</div>
    <div id="controls">
      <button id="addRelTypeBtn">+ Add Rel Type</button>
    </div>
  </div>

  <div id="sidebar" class="hidden">
    <h2>Edit Character</h2>
    <label>Name</label><input id="nName" />
    <label>Age</label><input id="nAge" />
    <label>Gender</label>
    <select id="nGender">
      <option value="">Unknown</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
    <label>DOB</label><input id="nDOB" type="date" />
    <label>DOD</label><input id="nDOD" type="date" />
    <label>Notes</label><textarea id="nNotes" rows="3"></textarea>

    <div class="rel-buttons" id="relButtons"></div>
    <button id="saveBtn">Save</button>
    <button id="deleteBtn" style="background:#c53;color:#fff;margin-top:10px;">Delete</button>
  </div>

  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script>
    // --- Data & Relationship Types ---
    let idCount = 0;
    function newId(){ return 'n'+(++idCount); }

    const relTypes = [
      { key:'parent',  label:'Parent', style:{dashes:false, color:'#000'} },
      { key:'child',   label:'Child',  style:{dashes:false, color:'#000'} },
      { key:'sibling', label:'Sibling',style:{dashes:false, color:'#000'} },
      { key:'partner', label:'Partner',style:{dashes:true,  color:'#333'} },
      { key:'affair',  label:'Affair', style:{dashes:true,  color:'#c00'} }
    ];

    // Nodes & Edges
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();

    // Initial root node
    nodes.add({
      id: newId(),
      label: 'Main OC',
      name: 'Main OC', age:'', gender:'', dob:'', dod:'', notes:''
    });

    // --- vis.js Network Setup ---
    const container = document.getElementById('network');
    const network = new vis.Network(container, { nodes, edges }, {
      layout:{ hierarchical:false },
      interaction:{ dragNodes:true, dragView:true, zoomView:true },
      physics:{ enabled:false },
      nodes:{ shape:'box', margin:10, color:{border:'#446688', background:'#fff'} },
      edges:{ arrows:{ to:{enabled:true,type:'arrow'}}, smooth:{type:'straightCross'} }
    });

    // --- Sidebar References ---
    const sidebar = document.getElementById('sidebar');
    const fld = {
      name:  document.getElementById('nName'),
      age:   document.getElementById('nAge'),
      gender:document.getElementById('nGender'),
      dob:   document.getElementById('nDOB'),
      dod:   document.getElementById('nDOD'),
      notes: document.getElementById('nNotes')
    };
    const relButtons = document.getElementById('relButtons');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    let selectedId = null;

    // --- Utility: Create relationship edge ---
    function addRel(from, to, style) {
      edges.add({ from, to,
        dashes: style.dashes,
        color: { color: style.color },
        arrows: { to:{enabled:true,type:'arrow'} },
        smooth: { type:'straightCross' }
      });
    }

    // --- Handle Node Selection ---
    network.on('selectNode', params => {
      selectedId = params.nodes[0];
      const data = nodes.get(selectedId);

      // Populate fields
      fld.name.value   = data.name;
      fld.age.value    = data.age;
      fld.gender.value = data.gender;
      fld.dob.value    = data.dob;
      fld.dod.value    = data.dod;
      fld.notes.value  = data.notes;

      // Build rel-buttons
      relButtons.innerHTML = '';
      relTypes.forEach(rt => {
        const b = document.createElement('button');
        b.textContent = rt.label;
        b.onclick = () => {
          const nid = newId();
          nodes.add({
            id: nid,
            label: rt.label,
            name: rt.label, age:'', gender:'', dob:'', dod:'', notes:''
          });
          // parent: edge â†’ selected; child: selected â†’ edge; sibling: link both ways via common parent?
          if(rt.key==='parent')   addRel(nid, selectedId, rt.style);
          if(rt.key==='child')    addRel(selectedId, nid, rt.style);
          if(rt.key==='sibling') {
            // find parents of selected, link new node to same parents
            edges.get().filter(e=>e.to===selectedId && !e.dashes)
                         .forEach(e=>addRel(e.from, nid, rt.style));
          }
          if(rt.key==='partner')  addRel(selectedId, nid, rt.style), addRel(nid, selectedId, rt.style);
          if(rt.key==='affair')   addRel(selectedId, nid, rt.style), addRel(nid, selectedId, rt.style);
        };
        relButtons.appendChild(b);
      });

      // Show sidebar
      sidebar.classList.remove('hidden');
    });

    network.on('deselectNode', ()=>{ selectedId = null; sidebar.classList.add('hidden'); });

    // --- Save Edits ---
    saveBtn.onclick = () => {
      if (!selectedId) return;
      const upd = { id: selectedId };
      upd.name   = fld.name.value;
      upd.age    = fld.age.value;
      upd.gender = fld.gender.value;
      upd.dob    = fld.dob.value;
      upd.dod    = fld.dod.value;
      upd.notes  = fld.notes.value;

      // Reconstruct label (multi-line)
      let lbl = upd.name;
      if (upd.age)    lbl += '\\nAge: ' + upd.age;
      if (upd.dob)    lbl += '\\nBorn: ' + upd.dob;
      if (upd.dod)    lbl += '\\nDied: ' + upd.dod;
      upd.label = lbl;

      // Node color by gender
      if (upd.gender==='male')    upd.color = {border:'#4b8bbe',background:'#eef4fc'};
      if (upd.gender==='female')  upd.color = {border:'#d2527f',background:'#fdeef4'};
      nodes.update(upd);
    };

    // --- Delete Node ---
    deleteBtn.onclick = () => {
      if (!selectedId) return;
      nodes.remove({ id: selectedId });
      edges.get().forEach(e => {
        if (e.from===selectedId || e.to===selectedId) edges.remove(e.id);
      });
      sidebar.classList.add('hidden');
    };

    // --- Add Rel Type ---
    document.getElementById('addRelTypeBtn').onclick = () => {
      const label = prompt('New relationship type label (e.g. "Godparent")');
      if (!label) return;
      const key = label.toLowerCase().replace(/\\s+/g,'');
      relTypes.push({ key, label, style:{ dashes:false, color:'#555'} });
      if (selectedId) network.selectNodes([selectedId]); // rebuild sidebar
    };
  </script>
</body>
</html>
